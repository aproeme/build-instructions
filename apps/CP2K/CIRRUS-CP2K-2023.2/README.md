# Introduction

These instructions are for building CP2K version 2023.2 on Cirrus

# Preliminaries

## Download CP2K

Download the .tar.bz2 version of the release so that DBCSR is already included:

```
wget https://github.com/cp2k/cp2k/releases/download/v2023.2/cp2k-2023.2.tar.bz2
```

Uncompress: 

```
tar xjf cp2k-2023.2.tar.bz2
```

# Build dependencies using toolchain and generate arch file

Navigate to the toolchain directory:

```
cd cp2k-2023.2/tools/toolchain

```

Load Intel compilers, MPI and Math Kernel Library (MKL):

```
module load intel-20.4/compilers 
module load intel-20.4/mpi
module load intel-20.4/cmkl
```

Build dependencies using the CP2K toolchain:

```
./install_cp2k_toolchain.sh --math-mode=mkl --mpi-mode=intelmpi --with-intel-classic --with-mkl --with-elpa=no
```

Note: not using ELPA as for this release and this version of the Intel compiler the toolchain build of ELPA fails at configure stage because it determines `mpiicpc` does not support c++17. 

Once the toolchain build of all dependencies completes, copy the `.psmp` arch file to the directory of arch files:

```
cp ./install/arch/local.psmp ../../arch/
```

# Build CP2K

Make sure the same modules are loaded as were loaded during the toolchain build:

```
module load intel-20.4/compilers 
module load intel-20.4/mpi
module load intel-20.4/cmkl
```

Source the environment setup generated by the toolchain build of dependencies:

```
source cp2k-2023.2/tools/toolchain/install/setup
```

Build CP2K using the arch file generated by the toolchain:

```
make -j 18 ARCH=local VERSION=psmp

```

The resulting executable `cp2k.psmp` is now available within: `cp2k-2023.2/exe/local/`


# Running CP2K

To run CP2K, always source the environment setup generated by the toolchain first:

```
source cp2k-2023.2/tools/toolchain/install/setup
```

